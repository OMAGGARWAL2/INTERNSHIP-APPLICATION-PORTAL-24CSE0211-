<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - InternHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --cream:#f6f1e7; --blue:#1e3a8a; --sea:#0ea5e9; }
        body { background: var(--cream); color: var(--blue); font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        .card { border-color: rgba(30,58,138,0.15); }
        .list-group-item { border-color: rgba(30,58,138,0.1); }
        .chat-header { background: linear-gradient(135deg, var(--blue), var(--sea)); color: #fff; }
        .message-bubble { max-width: 75%; padding: .75rem 1rem; border-radius: 1rem; border: 1px solid rgba(30,58,138,0.15); }
        .msg-you { background: #fff; }
        .msg-me { background: rgba(14,165,233,0.12); margin-left: auto; }
        .btn-primary { background: linear-gradient(135deg, var(--blue), var(--sea)); border: none; }
        .form-control:focus { box-shadow: 0 0 0 .25rem rgba(14,165,233,.25); border-color: var(--sea); }
        .conversation-item.active { background: rgba(14,165,233,0.08); }
        .resume-attachment { background: rgba(14,165,233,0.1); padding: .5rem; border-radius: .5rem; margin-top: .5rem; display: inline-flex; align-items: center; gap: .5rem; }
        .resume-attachment a { color: var(--blue); text-decoration: none; font-weight: 500; }
        .resume-attachment i { color: var(--sea); }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex align-items-center mb-3">
        <a href="index.html" class="text-decoration-none me-2" style="color:var(--blue)"><i class="fas fa-arrow-left"></i></a>
        <h4 class="m-0">Messages</h4>
    </div>
    <div class="row g-3">
        <div class="col-12 col-md-4">
            <div class="card h-100">
                <div class="card-header bg-white" style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>Conversations</strong>
                    <button onclick="clearAllConversations()" style="padding: 0.3rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;" title="Clear all conversations">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
                <ul id="conversationList" class="list-group list-group-flush" style="max-height: 70vh; overflow:auto;"></ul>
            </div>
        </div>
        <div class="col-12 col-md-8">
            <div class="card h-100">
                <div class="card-header chat-header d-flex align-items-center justify-content-between">
                    <div>
                        <div id="chatCompany" class="fw-semibold">Select a conversation</div>
                        <small id="chatSubtitle" class="opacity-75">Internship application</small>
                    </div>
                    <span class="badge bg-light text-dark" id="chatStatus"><i class="fas fa-circle me-1" style="font-size:.6rem;"></i>Active</span>
                </div>
                <div id="chatBody" class="card-body" style="height:55vh; overflow:auto; background:#fff7;">
                    <div class="text-center text-muted">No messages yet</div>
                </div>
                <div class="card-footer bg-white">
                    <form id="messageForm" class="d-flex flex-column gap-2">
                        <div class="d-flex gap-2">
                            <input id="messageInput" class="form-control" placeholder="Type your message..." autocomplete="off">
                            <label class="btn btn-outline-primary" style="cursor: pointer; margin: 0;">
                                <i class="fas fa-paperclip"></i>
                                <input type="file" id="resumeAttachment" accept=".pdf,.doc,.docx" style="display: none;" onchange="handleFileAttachment(event)">
                            </label>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i></button>
                        </div>
                        <div id="fileAttachmentInfo" style="display: none; padding: .5rem; background: rgba(14,165,233,0.1); border-radius: .5rem;">
                            <i class="fas fa-file"></i> <span id="fileName"></span> <button type="button" class="btn btn-sm btn-link" onclick="removeAttachment()">Remove</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Utilities
function getConversations(){ return JSON.parse(localStorage.getItem('conversations')||'[]'); }
function saveConversations(c){ localStorage.setItem('conversations', JSON.stringify(c)); }

// Seed a conversation if redirected from apply or job detail
(() => {
  const pending = JSON.parse(sessionStorage.getItem('newConversation')||'null');
  if (pending) {
    const convos = getConversations();
    // Check if conversation already exists for this internship
    const existing = convos.find(c => c.internshipId === pending.internshipId && c.company === pending.company);
    if (existing) {
      // Just open the existing conversation
      activeId = existing.id;
    } else {
      // Create new conversation
      convos.unshift({ 
        id: Date.now(), 
        company: pending.company||'Company', 
        title: pending.title||'Application', 
        internshipId: pending.internshipId||null, 
        messages: [ 
          { 
            from:'system', 
            text:`Your application for ${pending.title} at ${pending.company} was received. You can now message the company to ask questions or provide additional information.`, 
            ts: new Date().toISOString() 
          } 
        ] 
      });
      saveConversations(convos);
      activeId = convos[0].id;
    }
    sessionStorage.removeItem('newConversation');
  }
})();

// Render conversations
let activeId = null;
let currentUserType = 'intern'; // 'intern' or 'hirer'

// Detect user type
(function() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  const hirerProfile = JSON.parse(localStorage.getItem('hirerProfile') || 'null');
  
  // Check if user is a hirer (has hirer profile or logged in as hirer)
  if (hirerProfile || (currentUser && currentUser.userType === 'hirer')) {
    currentUserType = 'hirer';
  } else if (currentUser) {
    currentUserType = 'intern';
  }
})();

function openConversation(id){
  activeId = id;
  const convos = getConversations();
  const convo = convos.find(c=>c.id===id);
  if (!convo) {
    document.getElementById('chatCompany').textContent = 'Select a conversation';
    document.getElementById('chatSubtitle').textContent = '';
    document.getElementById('chatBody').innerHTML = '<div class="text-center text-muted">Conversation not found</div>';
    return;
  }
  document.getElementById('chatCompany').textContent = convo.company || 'Company';
  document.getElementById('chatSubtitle').textContent = convo.title || 'Conversation';
  const body = document.getElementById('chatBody');
  body.innerHTML = (convo.messages||[]).map(m => {
    let messageContent = m.text || '';
    if (m.resumeAttachment) {
      messageContent += `<div class="resume-attachment">
        <i class="fas fa-file-pdf"></i>
        <a href="${m.resumeAttachment.data}" download="${m.resumeAttachment.name}">${m.resumeAttachment.name}</a>
      </div>`;
    }
    if (m.from==='me') return `<div class="d-flex mb-2"><div class="message-bubble msg-me ms-auto">${messageContent}</div></div>`;
    if (m.from==='system') return `<div class="d-flex mb-2 justify-content-center"><div class="message-bubble" style="background: rgba(52,199,89,0.1); color: var(--blue); max-width: 90%; text-align: center;">${messageContent}</div></div>`;
    return `<div class="d-flex mb-2"><div class="message-bubble msg-you">${messageContent}</div></div>`;
  }).join('');
  body.scrollTop = body.scrollHeight;
  renderConversations();
}

let attachedFile = null;

function handleFileAttachment(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
  if (!allowedTypes.includes(file.type)) {
    alert('Please upload a PDF or DOC/DOCX file.');
    e.target.value = '';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    attachedFile = {
      name: file.name,
      data: e.target.result,
      type: file.type
    };
    
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileAttachmentInfo').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function removeAttachment() {
  attachedFile = null;
  document.getElementById('resumeAttachment').value = '';
  document.getElementById('fileAttachmentInfo').style.display = 'none';
}

// Enhanced message gateway - proper message sending
document.getElementById('messageForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  
  // Validation
  if (!text && !attachedFile) {
    alert('Please enter a message or attach a file');
    return;
  }
  
  if (activeId === null) {
    alert('Please select a conversation first');
    return;
  }
  
  const convos = getConversations();
  const convo = convos.find(c=>c.id===activeId);
  if (!convo) {
    alert('Conversation not found. Please refresh the page.');
    return;
  }
  
  // Determine sender based on user type
  const senderFrom = currentUserType === 'hirer' ? 'hirer' : 'me';
  
  const message = { 
    from: senderFrom, 
    text: text || 'Shared a resume', 
    ts: new Date().toISOString(),
    senderType: currentUserType
  };
  
  if (attachedFile) {
    message.resumeAttachment = {
      name: attachedFile.name,
      data: attachedFile.data,
      type: attachedFile.type
    };
  }
  
  // Add message to conversation
  convo.messages.push(message);
  convo.lastMessage = message.text || 'Shared a file';
  convo.lastMessageTime = message.ts;
  saveConversations(convos);
  
  // Clear input
  input.value='';
  removeAttachment();
  
  // Refresh conversation view
  openConversation(activeId);
  
  // Auto-reply for hirers (if hirer is sending)
  if (currentUserType === 'intern') {
    // Simulated auto-reply from company (only if intern sent message)
    setTimeout(()=>{
      const replyText = attachedFile 
        ? `Thank you for sharing your resume. Our team will review it and get back to you shortly.`
        : `Thanks for your message. Our team will review and get back shortly.`;
      const c2 = getConversations();
      const cv = c2.find(c=>c.id===activeId);
      if (!cv) return;
      cv.messages.push({ 
        from: currentUserType === 'hirer' ? 'hirer' : 'you', 
        text: replyText, 
        ts: new Date().toISOString(),
        senderType: 'hirer'
      });
      cv.lastMessage = replyText;
      cv.lastMessageTime = new Date().toISOString();
      saveConversations(c2);
      if (activeId===cv.id) openConversation(cv.id);
    }, 1500);
  }
});

// Clear all conversations
function clearAllConversations() {
  const convos = getConversations();
  if (convos.length === 0) {
    alert('No conversations to clear');
    return;
  }
  
  if (confirm(`Are you sure you want to delete all ${convos.length} conversation(s)?\n\nThis action cannot be undone.`)) {
    saveConversations([]);
    activeId = null;
    renderConversations();
    document.getElementById('chatBody').innerHTML = '<div class="text-center text-muted">No conversations</div>';
    document.getElementById('chatCompany').textContent = 'Select a conversation';
    document.getElementById('chatSubtitle').textContent = '';
    alert('All conversations cleared');
  }
}

// Delete single conversation
function deleteConversation(convoId) {
  if (!confirm('Are you sure you want to delete this conversation?')) return;
  
  const convos = getConversations();
  const filtered = convos.filter(c => c.id !== convoId);
  saveConversations(filtered);
  
  if (activeId === convoId) {
    activeId = null;
    document.getElementById('chatBody').innerHTML = '<div class="text-center text-muted">Select a conversation</div>';
    document.getElementById('chatCompany').textContent = 'Select a conversation';
    document.getElementById('chatSubtitle').textContent = '';
  }
  
  renderConversations();
}

// Enhanced conversation rendering with delete option
function renderConversations(){
  const list = document.getElementById('conversationList');
  const convos = getConversations();
  
  // Filter conversations based on user type
  let userConversations = convos;
  if (currentUserType === 'hirer') {
    // Hirers see conversations where they are the company
    const hirerProfile = JSON.parse(localStorage.getItem('hirerProfile') || 'null');
    if (hirerProfile && hirerProfile.company) {
      userConversations = convos.filter(c => c.company === hirerProfile.company);
    }
  } else {
    // Interns see all their conversations
    userConversations = convos;
  }
  
  if (userConversations.length === 0) {
    list.innerHTML = `<li class="list-group-item text-center text-muted py-4">No conversations yet</li>`;
    document.getElementById('chatBody').innerHTML = '<div class="text-center text-muted">Select a conversation to start messaging</div>';
    return;
  }
  
  list.innerHTML = userConversations.map(c => `
    <li class="list-group-item conversation-item ${c.id===activeId?'active':''}" data-id="${c.id}" style="cursor: pointer; position: relative;">
      <div class="d-flex align-items-start justify-content-between">
        <div style="flex: 1;">
          <div class="fw-semibold">${c.company || 'Company'}</div>
          <small class="text-muted">${c.title || 'Conversation'}</small>
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">
          <button onclick="event.stopPropagation(); deleteConversation(${c.id})" style="background: transparent; border: none; color: #ef4444; cursor: pointer; padding: 0.2rem; font-size: 0.8rem;" title="Delete conversation">
            <i class="fas fa-times"></i>
          </button>
          <small class="text-muted">${(c.messages?.at(-1)?.ts||'').slice(11,16)}</small>
        </div>
      </div>
    </li>
  `).join('');
  Array.from(list.children).forEach(li => li.onclick = () => openConversation(parseInt(li.dataset.id)));
  if (activeId===null && userConversations.length) openConversation(userConversations[0].id);
}

// Initialize render
renderConversations();
</script>
</body>
</html>

